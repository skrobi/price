{% extends "base.html" %}
{% block title %}Ustawienia koszyka: {{ basket.name }}{% endblock %}
{% block content %}

<div style="margin-bottom: 20px;">
    <a href="{{ url_for('baskets.basket_detail', basket_id=basket.basket_id) }}" style="color: #007bff; text-decoration: none;">â† PowrÃ³t do koszyka</a>
</div>

<h1>âš™ï¸ Ustawienia koszyka</h1>

<div style="background: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 5px;">
    <strong>Koszyk:</strong> {{ basket.name }}<br>
    <strong>ID:</strong> {{ basket.basket_id }}<br>
    <strong>Produkty:</strong> {{ basket.basket_items|length }}<br>
    <strong>Utworzony:</strong> {{ basket.created[:19] }}<br>
    <strong>Ostatnio zmodyfikowany:</strong> {{ basket.updated[:19] }}
</div>

{% with messages = get_flashed_messages() %}
    {% if messages %}
        <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 10px; margin: 10px 0; color: #155724; border-radius: 5px;">
            {% for message in messages %}
                <div>{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<form method="POST">
    <div class="form-group" style="margin: 15px 0;">
        <label><strong>ğŸ“ Nazwa koszyka:</strong></label><br>
        <input type="text" name="name" value="{{ basket.name }}" style="width: 400px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
    </div>

    <div class="form-group" style="margin: 15px 0;">
        <label><strong>ğŸ¯ Priorytet optymalizacji:</strong></label><br>
        <select name="priority" style="width: 300px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            <option value="lowest_total_cost" {% if basket.optimization_settings.priority == 'lowest_total_cost' %}selected{% endif %}>
                ğŸ’° NajniÅ¼szy koszt caÅ‚kowity
            </option>
            <option value="fewest_shops" {% if basket.optimization_settings.priority == 'fewest_shops' %}selected{% endif %}>
                ğŸª Najmniej sklepÃ³w
            </option>
            <option value="balanced" {% if basket.optimization_settings.priority == 'balanced' %}selected{% endif %}>
                âš–ï¸ Zbalansowany
            </option>
        </select>
        <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
            <strong>NajniÅ¼szy koszt:</strong> Minimalizuje caÅ‚kowitÄ… kwotÄ™<br>
            <strong>Najmniej sklepÃ³w:</strong> Preferuje konsolidacjÄ™ zamÃ³wieÅ„<br>
            <strong>Zbalansowany:</strong> Kompromis miÄ™dzy cenÄ… a liczbÄ… sklepÃ³w (kara 15 PLN za kaÅ¼dy dodatkowy sklep)
        </div>
    </div>

    <div class="form-group" style="margin: 15px 0;">
        <label><strong>ğŸª Maksymalna liczba sklepÃ³w:</strong></label><br>
        <input type="range" name="max_shops" 
               value="{{ basket.optimization_settings.max_shops }}" 
               min="1" max="10" step="1"
               oninput="updateShopsDisplay(this.value)"
               style="width: 200px;">
        <span id="shops-display" style="margin-left: 10px; font-weight: bold;">{{ basket.optimization_settings.max_shops }}</span>
        <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
            Ogranicza liczbÄ™ sklepÃ³w w optymalnym rozwiÄ…zaniu. Mniej sklepÃ³w = wygoda, wiÄ™cej sklepÃ³w = potencjalnie niÅ¼sze ceny.
        </div>
    </div>

    <!-- NOWE: Maksymalna liczba kombinacji -->
    <div style="margin: 25px 0; padding: 20px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
        <h3 style="margin-top: 0;">ğŸ”¥ Zaawansowane ustawienia algorytmu</h3>
        
        <div class="form-group" style="margin: 15px 0;">
            <label><strong>ğŸ§® Maksymalna liczba kombinacji do sprawdzenia:</strong></label><br>
            <select name="max_combinations" style="width: 200px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                {% set max_combos = basket.optimization_settings.get('max_combinations', 200000) %}
                <option value="2000" {% if max_combos == 2000 %}selected{% endif %}>2,000 - Szybkie</option>
                <option value="10000" {% if max_combos == 10000 %}selected{% endif %}>10,000 - Podstawowe</option>
                <option value="50000" {% if max_combos == 50000 %}selected{% endif %}>50,000 - DokÅ‚adne</option>
                <option value="200000" {% if max_combos == 200000 %}selected{% endif %}>200,000 - Bardzo dokÅ‚adne</option>
                <option value="500000" {% if max_combos == 500000 %}selected{% endif %}>500,000 - Maksymalne</option>
                <option value="1000000" {% if max_combos == 1000000 %}selected{% endif %}>1,000,000 - Ekstremalne</option>
            </select>
            <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                <strong>WiÄ™cej kombinacji = dokÅ‚adniejszy wynik, ale dÅ‚uÅ¼szy czas obliczeÅ„.</strong><br>
                â€¢ 2,000 - dla szybkich testÃ³w<br>
                â€¢ 200,000 - zalecane dla normalnego uÅ¼ytku<br>
                â€¢ 1,000,000 - gdy chcesz sprawdziÄ‡ kaÅ¼dÄ… moÅ¼liwÄ… opcjÄ™
            </div>
        </div>
    </div>

    <!-- SEKCJA ZAMIENNIKÃ“W -->
    <div style="margin: 25px 0; padding: 20px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #28a745;">
        <h3 style="margin-top: 0;">ğŸ”„ Ustawienia zamiennikÃ³w produktÃ³w</h3>
        
        <div class="form-group" style="margin: 15px 0;">
            <label style="display: flex; align-items: center;">
                <input type="checkbox" name="allow_substitutes" 
                       {% if basket.optimization_settings.get('substitute_settings', {}).get('allow_substitutes', True) %}checked{% endif %}
                       onchange="toggleSubstituteOptions()"
                       style="margin-right: 10px;">
                <strong>ğŸ”„ Zezwalaj na zamienniki w tym koszyku</strong>
            </label>
            <div style="font-size: 0.9em; color: #666; margin-top: 5px; margin-left: 25px;">
                Gdy wÅ‚Ä…czone, system moÅ¼e zastÄ™powaÄ‡ niedostÄ™pne lub drogie produkty taÅ„szymi zamiennikmi.
                <br><strong>NOWE:</strong> JeÅ›li w koszyku sÄ… produkty A+B z tej samej grupy zamiennikÃ³w - system poÅ‚Ä…czy ich iloÅ›ci!
            </div>
        </div>

        <div id="substitute-options" style="margin: 20px 0; {% if not basket.optimization_settings.get('substitute_settings', {}).get('allow_substitutes', True) %}display: none;{% endif %}">
            <div class="form-group" style="margin: 15px 0;">
                <label><strong>ğŸ’¸ Maksymalny wzrost ceny dla zamiennikÃ³w (%):</strong></label><br>
                <input type="range" name="max_price_increase_percent" 
                       value="{{ basket.optimization_settings.get('substitute_settings', {}).get('max_price_increase_percent', 20) }}" 
                       min="0" max="50" step="5"
                       oninput="updatePriceIncreaseDisplay(this.value)"
                       style="width: 300px;">
                <span id="price-increase-display" style="margin-left: 10px; font-weight: bold;">{{ basket.optimization_settings.get('substitute_settings', {}).get('max_price_increase_percent', 20) }}%</span>
                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                    Zamienniki mogÄ… byÄ‡ maksymalnie o tyle droÅ¼sze od oryginaÅ‚u. 0% = tylko taÅ„sze zamienniki.
                </div>
            </div>

            <div class="form-group" style="margin: 15px 0;">
                <label style="display: flex; align-items: center;">
                    <input type="checkbox" name="prefer_original" 
                           {% if basket.optimization_settings.get('substitute_settings', {}).get('prefer_original', True) %}checked{% endif %}
                           style="margin-right: 10px;">
                    <strong>â­ Preferuj oryginalne produkty</strong>
                </label>
                <div style="font-size: 0.9em; color: #666; margin-top: 5px; margin-left: 25px;">
                    System wybierze zamiennik tylko jeÅ›li jest znacznie taÅ„szy lub oryginaÅ‚ jest niedostÄ™pny.
                </div>
            </div>

            <div class="form-group" style="margin: 15px 0;">
                <label><strong>ğŸ“¢ Maksymalna liczba zamiennikÃ³w na produkt:</strong></label><br>
                <select name="max_substitutes_per_product" style="width: 150px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    {% set max_subs = basket.optimization_settings.get('substitute_settings', {}).get('max_substitutes_per_product', 3) %}
                    <option value="1" {% if max_subs == 1 %}selected{% endif %}>1</option>
                    <option value="2" {% if max_subs == 2 %}selected{% endif %}>2</option>
                    <option value="3" {% if max_subs == 3 %}selected{% endif %}>3</option>
                    <option value="5" {% if max_subs == 5 %}selected{% endif %}>5</option>
                    <option value="10" {% if max_subs == 10 %}selected{% endif %}>Bez limitu</option>
                </select>
                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                    Ile zamiennikÃ³w system moÅ¼e rozwaÅ¼yÄ‡ dla kaÅ¼dego produktu podczas optymalizacji.
                </div>
            </div>

            <div class="form-group" style="margin: 15px 0;">
                <label style="display: flex; align-items: center;">
                    <input type="checkbox" name="show_substitute_reasons" 
                           {% if basket.optimization_settings.get('substitute_settings', {}).get('show_substitute_reasons', True) %}checked{% endif %}
                           style="margin-right: 10px;">
                    <strong>ğŸ“ Pokazuj powody zastÄ…pieÅ„</strong>
                </label>
                <div style="font-size: 0.9em; color: #666; margin-top: 5px; margin-left: 25px;">
                    W wynikach optymalizacji bÄ™dÄ… pokazane powody zastÄ…pienia produktÃ³w zamiennikmi.
                </div>
            </div>
        </div>
    </div>

    <!-- POZOSTAÅE USTAWIENIA -->
    <div class="form-group" style="margin: 15px 0;">
        <label style="display: flex; align-items: center;">
            <input type="checkbox" name="suggest_quantities" 
                   {% if basket.optimization_settings.suggest_quantities %}checked{% endif %}
                   style="margin-right: 10px;">
            <strong>ğŸ“ˆ Sugeruj optymalne iloÅ›ci</strong>
        </label>
        <div style="font-size: 0.9em; color: #666; margin-top: 5px; margin-left: 25px;">
            System bÄ™dzie sugerowaÄ‡ zakup wiÄ™kszych iloÅ›ci jeÅ›li pozwoli to na darmowÄ… dostawÄ™ lub rabaty.
        </div>
    </div>

    <div class="form-group" style="margin: 15px 0;">
        <label><strong>ğŸ’µ PrÃ³g oszczÄ™dnoÅ›ci (PLN):</strong></label><br>
        <input type="number" name="min_savings_threshold" 
               value="{{ basket.optimization_settings.min_savings_threshold }}" 
               min="0" max="100" step="0.5"
               style="width: 150px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
            Minimalne oszczÄ™dnoÅ›ci wymagane do zasugerowania zmiany iloÅ›ci.
        </div>
    </div>

    <div class="form-group" style="margin: 15px 0;">
        <label style="display: flex; align-items: center;">
            <input type="checkbox" name="consider_free_shipping" 
                   {% if basket.optimization_settings.consider_free_shipping %}checked{% endif %}
                   style="margin-right: 10px;">
            <strong>ğŸšš UwzglÄ™dniaj darmowÄ… dostawÄ™</strong>
        </label>
        <div style="font-size: 0.9em; color: #666; margin-top: 5px; margin-left: 25px;">
            System uwzglÄ™dni warunki darmowej dostawy w sklepach przy optymalizacji.
        </div>
    </div>

    <div class="form-group" style="margin: 15px 0;">
        <label><strong>ğŸ“¢ Maksymalny mnoÅ¼nik iloÅ›ci:</strong></label><br>
        <input type="number" name="max_quantity_multiplier" 
               value="{{ basket.optimization_settings.max_quantity_multiplier }}" 
               min="1" max="10" step="1"
               style="width: 150px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
            Maksymalna wielokrotnoÅ›Ä‡ Å¼Ä…danej iloÅ›ci (np. 3 = maksymalnie 3x wiÄ™cej niÅ¼ Å¼Ä…dano).
        </div>
    </div>

    <div class="form-group" style="margin: 15px 0;">
        <label style="display: flex; align-items: center;">
            <input type="checkbox" name="show_logs" 
                   {% if basket.optimization_settings.show_logs %}checked{% endif %}
                   style="margin-right: 10px;">
            <strong>ğŸ“Š Pokazuj szczegÃ³Å‚owe logi optymalizacji</strong>
        </label>
        <div style="font-size: 0.9em; color: #666; margin-top: 5px; margin-left: 25px;">
            Po optymalizacji zostanie wyÅ›wietlony szczegÃ³Å‚owy log ze wszystkimi sprawdzonymi kombinacjami.
        </div>
    </div>

    <!-- PODGLÄ„D USTAWIEÅƒ -->
    <div style="background: #e9ecef; padding: 15px; margin: 20px 0; border-radius: 5px;">
        <h4>ğŸ§ª PodglÄ…d ustawieÅ„:</h4>
        <div id="settings-preview">
            <div><strong>Priorytet:</strong> <span id="preview-priority">{{ basket.optimization_settings.priority }}</span></div>
            <div><strong>Max sklepÃ³w:</strong> <span id="preview-shops">{{ basket.optimization_settings.max_shops }}</span></div>
            <div><strong>Max kombinacji:</strong> <span id="preview-combinations">{{ basket.optimization_settings.get('max_combinations', 200000) | int | filesizeformat | replace('B', '') }} kombinacji</span></div>
            <div><strong>Sugestie iloÅ›ci:</strong> <span id="preview-suggestions">{% if basket.optimization_settings.suggest_quantities %}Tak{% else %}Nie{% endif %}</span></div>
            <div><strong>PrÃ³g oszczÄ™dnoÅ›ci:</strong> <span id="preview-threshold">{{ basket.optimization_settings.min_savings_threshold }}</span> PLN</div>
            <div><strong>Logi:</strong> <span id="preview-logs">{% if basket.optimization_settings.show_logs %}WÅ‚Ä…czone{% else %}WyÅ‚Ä…czone{% endif %}</span></div>
            <div><strong>Zamienniki:</strong> <span id="preview-substitutes">{% if basket.optimization_settings.get('substitute_settings', {}).get('allow_substitutes', True) %}WÅ‚Ä…czone{% else %}WyÅ‚Ä…czone{% endif %}</span></div>
            <div id="preview-substitute-details" {% if not basket.optimization_settings.get('substitute_settings', {}).get('allow_substitutes', True) %}style="display: none;"{% endif %}>
                <small style="color: #666;">Max wzrost ceny: <span id="preview-price-increase">{{ basket.optimization_settings.get('substitute_settings', {}).get('max_price_increase_percent', 20) }}</span>%</small>
            </div>
        </div>
    </div>

    <div class="form-group" style="margin: 25px 0;">
        <button type="submit" class="btn" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; margin-right: 10px;">
            ğŸ’¾ Zapisz ustawienia
        </button>
        <a href="{{ url_for('baskets.basket_detail', basket_id=basket.basket_id) }}" 
           class="btn" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 4px; text-decoration: none;">
           Anuluj
        </a>
    </div>
</form>

<!-- PORADY -->
<div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 5px;">
    <h3>ğŸ’¡ Porady dotyczÄ…ce ustawieÅ„</h3>
    
    <div style="margin: 15px 0;">
        <strong>ğŸ¯ WybÃ³r priorytetu:</strong>
        <ul style="margin-top: 5px;">
            <li><strong>NajniÅ¼szy koszt:</strong> Idealne dla budÅ¼etowych zakupÃ³w - znajdzie najtaÅ„szÄ… opcjÄ™ nawet jeÅ›li oznacza to wiÄ™cej zamÃ³wieÅ„</li>
            <li><strong>Najmniej sklepÃ³w:</strong> Wygodne dla czÄ™stych zamÃ³wieÅ„ - preferuje mniejszÄ… liczbÄ™ sklepÃ³w</li>
            <li><strong>Zbalansowany:</strong> Uniwersalne rozwiÄ…zanie - kompromis miÄ™dzy cenÄ… a wygodÄ…</li>
        </ul>
    </div>
    
    <div style="margin: 15px 0;">
        <strong>ğŸ”¥ Liczba kombinacji:</strong>
        <p style="margin-top: 5px; color: #666;">
            <strong>NOWE!</strong> MoÅ¼esz teraz kontrolowaÄ‡ dokÅ‚adnoÅ›Ä‡ algorytmu. WiÄ™cej kombinacji = dokÅ‚adniejszy wynik, ale dÅ‚uÅ¼szy czas.
            Dla koszyka z 5 produktami w 3 sklepach = okoÅ‚o 243 kombinacji, ale z zamiennikmi moÅ¼e byÄ‡ ich dziesiÄ…tki tysiÄ™cy.
        </p>
    </div>
    
    <div style="margin: 15px 0;">
        <strong>ğŸª Limit sklepÃ³w:</strong>
        <p style="margin-top: 5px; color: #666;">
            <strong>NAPRAWIONE!</strong> System teraz EGZEKWUJE ten limit - nie przekroczy ustawionej liczby sklepÃ³w.
            Mniejsza liczba = wygoda (mniej przesyÅ‚ek), wiÄ™ksza liczba = potencjalnie niÅ¼sze ceny.
        </p>
    </div>

    <div style="margin: 15px 0;">
        <strong>ğŸ”„ Zamienniki produktÃ³w:</strong>
        <p style="margin-top: 5px; color: #666;">
            <strong>ULEPSZONE!</strong> System teraz automatycznie Å‚Ä…czy iloÅ›ci jeÅ›li w koszyku sÄ… produkty z tej samej grupy zamiennikÃ³w.
            PrzykÅ‚ad: iPhone 128GB (2szt) + iPhone 256GB (1szt) = 3szt Å‚Ä…cznie z grupy "iPhone 15".
        </p>
    </div>
</div>

<script>
function updateShopsDisplay(value) {
    document.getElementById('shops-display').textContent = value;
    document.getElementById('preview-shops').textContent = value;
}

function updatePriceIncreaseDisplay(value) {
    document.getElementById('price-increase-display').textContent = value + '%';
    document.getElementById('preview-price-increase').textContent = value;
}

function toggleSubstituteOptions() {
    const checkbox = document.querySelector('input[name="allow_substitutes"]');
    const options = document.getElementById('substitute-options');
    const preview = document.getElementById('preview-substitutes');
    const previewDetails = document.getElementById('preview-substitute-details');
    
    if (checkbox.checked) {
        options.style.display = 'block';
        preview.textContent = 'WÅ‚Ä…czone';
        previewDetails.style.display = 'block';
    } else {
        options.style.display = 'none';
        preview.textContent = 'WyÅ‚Ä…czone';
        previewDetails.style.display = 'none';
    }
}

// Aktualizuj podglÄ…d na bieÅ¼Ä…co
document.querySelector('select[name="priority"]').addEventListener('change', function() {
    document.getElementById('preview-priority').textContent = this.value;
});

document.querySelector('select[name="max_combinations"]').addEventListener('change', function() {
    const value = parseInt(this.value);
    const formatted = value.toLocaleString() + ' kombinacji';
    document.getElementById('preview-combinations').textContent = formatted;
});

document.querySelector('input[name="suggest_quantities"]').addEventListener('change', function() {
    document.getElementById('preview-suggestions').textContent = this.checked ? 'Tak' : 'Nie';
});

document.querySelector('input[name="min_savings_threshold"]').addEventListener('input', function() {
    document.getElementById('preview-threshold').textContent = this.value;
});

document.querySelector('input[name="show_logs"]').addEventListener('change', function() {
    document.getElementById('preview-logs').textContent = this.checked ? 'WÅ‚Ä…czone' : 'WyÅ‚Ä…czone';
});
</script>

{% endblock %}