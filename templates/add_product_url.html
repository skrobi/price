{% extends "base.html" %}
{% block title %}Dodaj produkt z URL{% endblock %}
{% block content %}

<div style="margin-bottom: 20px;">
    <a href="{{ url_for('products.products') }}" style="color: #007bff; text-decoration: none;">‚Üê Powr√≥t do produkt√≥w</a>
</div>

<h1>Dodaj produkt z URL</h1>

<div style="background: #e7f3ff; border: 1px solid #bee5eb; padding: 15px; margin: 15px 0; border-radius: 5px;">
    <strong>Jak to dzia≈Ça:</strong><br>
    1. Wklej URL produktu z dowolnego sklepu internetowego<br>
    2. <strong>WA≈ªNE: Wpisz nazwƒô produktu rƒôcznie</strong> (nie ufaj automatycznemu parsowaniu)<br>
    3. System rozpozna sklep z domeny URL<br>
    4. Produkt zostanie dodany wraz z linkiem do sklepu
</div>

{% with messages = get_flashed_messages() %}
    {% if messages %}
        <div style="background: #f8d7da; border: 1px solid #f5c6cb; padding: 10px; margin: 10px 0; color: #721c24; border-radius: 4px;">
            {% for message in messages %}
                <div>{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<form method="POST" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    
    <!-- Nazwa produktu - WYMAGANE POLE -->
    <div style="margin: 20px 0;">
        <label for="name"><strong>Nazwa produktu:</strong> <span style="color: red;">*</span></label><br>
        <input type="text" id="name" name="name" required 
               style="width: 100%; max-width: 700px; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; margin-top: 8px;" 
               placeholder="Wpisz dok≈ÇadnƒÖ nazwƒô produktu..."
               value="{{ request.form.get('name', '') }}">
        <small style="color: #666; display: block; margin-top: 5px;">
            ‚ö†Ô∏è <strong>ObowiƒÖzkowe!</strong> Wpisz nazwƒô rƒôcznie - nie polegaj na automatycznym wykrywaniu.
        </small>
    </div>
    
    <!-- URL produktu -->
    <div style="margin: 20px 0;">
        <label for="url"><strong>URL produktu:</strong> <span style="color: red;">*</span></label><br>
        <input type="url" id="url" name="url" required 
               style="width: 100%; max-width: 700px; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; margin-top: 8px;" 
               placeholder="https://allegro.pl/oferta/... lub https://amazon.pl/..."
               value="{{ request.form.get('url', '') }}"
               onchange="analyzeUrl()">
        <button type="button" onclick="analyzeUrl()" class="btn" style="background: #17a2b8; color: white; padding: 8px 16px; border: none; border-radius: 4px; margin-left: 10px; margin-top: 8px;">
            üîç Sprawd≈∫ sklep
        </button>
    </div>
    
    <!-- PodglƒÖd sklepu -->
    <div id="shop-preview" style="display: none; background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 6px; border-left: 4px solid #007bff;">
        <h4 style="margin-top: 0; color: #007bff;">üè™ Wykryty sklep</h4>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 15px 0;">
            <div>
                <strong>Nazwa sklepu:</strong><br>
                <div id="preview-shop-name" style="background: white; padding: 10px; border-radius: 4px; margin-top: 5px; border: 1px solid #ddd;">
                    <em>Analizowanie...</em>
                </div>
            </div>
            <div>
                <strong>Identyfikator sklepu:</strong><br>
                <div id="preview-shop-id" style="background: white; padding: 10px; border-radius: 4px; margin-top: 5px; border: 1px solid #ddd;">
                    <em>Analizowanie...</em>
                </div>
            </div>
        </div>
    </div>
    
    <div style="margin: 25px 0;">
        <button type="submit" style="background: #28a745; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold;" id="submit-btn">
            üöÄ Dodaj produkt
        </button>
        <a href="{{ url_for('products.products') }}" 
           style="background: #6c757d; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; margin-left: 15px; display: inline-block;">
            Anuluj
        </a>
    </div>
</form>

<div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; margin: 20px 0; border-radius: 6px;">
    <h4 style="margin-top: 0; color: #856404;">üí° Obs≈Çugiwane sklepy i logika:</h4>
    <ul style="margin-bottom: 0; color: #856404;">
        <li><strong>Allegro:</strong> allegro-offer (lub allegro-listing, allegro-brand w zale≈ºno≈õci od URL)</li>
        <li><strong>Amazon:</strong> amazon</li>
        <li><strong>Inne sklepy:</strong> {nazwa_domeny} (automatycznie wykrywane)</li>
        <li><strong>Wa≈ºne:</strong> Zawsze sprawd≈∫ czy nazwa produktu jest poprawna przed dodaniem!</li>
    </ul>
</div>

<script>
function analyzeUrl() {
    const url = document.getElementById('url').value;
    const preview = document.getElementById('shop-preview');
    
    if (!url) {
        preview.style.display = 'none';
        return;
    }
    
    try {
        const urlObj = new URL(url);
        const domain = urlObj.hostname.toLowerCase().replace('www.', '');
        
        let shopName = '';
        let shopId = '';
        
        // Analiza domeny
        if (domain.includes('allegro.pl')) {
            shopName = 'Allegro';
            if (url.includes('/listing') || url.includes('/category')) {
                shopId = 'allegro-listing';
            } else if (url.includes('/brand')) {
                shopId = 'allegro-brand';
            } else {
                shopId = 'allegro-offer';
            }
        } else if (domain.includes('amazon')) {
            shopName = 'Amazon';
            shopId = 'amazon';
        } else if (domain.includes('ceneo.pl')) {
            shopName = 'Ceneo';
            shopId = 'ceneo';
        } else if (domain.includes('morele.net')) {
            shopName = 'Morele';
            shopId = 'morele';
        } else if (domain.includes('x-kom.pl')) {
            shopName = 'X-kom';
            shopId = 'x_kom';
        } else if (domain.includes('mediamarkt.pl')) {
            shopName = 'MediaMarkt';
            shopId = 'mediamarkt';
        } else if (domain.includes('saturn.pl')) {
            shopName = 'Saturn';
            shopId = 'saturn';
        } else if (domain.includes('empik.com')) {
            shopName = 'Empik';
            shopId = 'empik';
        } else if (domain.includes('euro.com.pl')) {
            shopName = 'Euro';
            shopId = 'euro';
        } else if (domain.includes('doz.pl')) {
            shopName = 'DOZ';
            shopId = 'doz';
        } else if (domain.includes('rosa24.pl')) {
            shopName = 'Rosa24';
            shopId = 'rosa24';
        } else if (domain.includes('gemini.pl')) {
            shopName = 'Gemini';
            shopId = 'gemini';
        } else {
            // Nieznany sklep - u≈ºyj domeny
            const cleanDomain = domain.replace('.pl', '').replace('.com', '').replace('.net', '');
            shopName = cleanDomain.charAt(0).toUpperCase() + cleanDomain.slice(1);
            shopId = cleanDomain.replace('.', '_').replace('-', '_');
        }
        
        // Wy≈õwietl wyniki
        document.getElementById('preview-shop-name').textContent = shopName;
        document.getElementById('preview-shop-id').textContent = shopId;
        preview.style.display = 'block';
        
    } catch (e) {
        document.getElementById('preview-shop-name').textContent = 'B≈ÇƒÖd analizy URL';
        document.getElementById('preview-shop-id').textContent = 'Nieprawid≈Çowy URL';
        preview.style.display = 'block';
    }
}

// Animacja przycisku podczas wysy≈Çania
document.querySelector('form').addEventListener('submit', function(e) {
    const name = document.getElementById('name').value.trim();
    const url = document.getElementById('url').value.trim();
    
    if (!name) {
        e.preventDefault();
        alert('Nazwa produktu jest wymagana!');
        document.getElementById('name').focus();
        return false;
    }
    
    if (!url) {
        e.preventDefault();
        alert('URL produktu jest wymagany!');
        document.getElementById('url').focus();
        return false;
    }
    
    const btn = document.getElementById('submit-btn');
    btn.textContent = '‚è≥ Dodawanie produktu...';
    btn.disabled = true;
});

// Automatyczna analiza przy za≈Çadowaniu je≈õli URL ju≈º jest wpisany
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('url').value) {
        analyzeUrl();
    }
});
</script>

{% endblock %}