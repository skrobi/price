{% extends "base.html" %}
{% block title %}Ustawienia Cen{% endblock %}
{% block content %}

<div style="margin-bottom: 20px;">
    <a href="{{ url_for('prices.prices') }}" style="color: #007bff; text-decoration: none;">← Powrót do cen</a>
</div>

<h1>Ustawienia Cen i Użytkownika</h1>

<!-- Informacje o użytkowniku -->
<div style="background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 8px;">
    <h3 style="margin-top: 0;">Informacje o instancji</h3>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
        <div>
            <strong>Nazwa instancji:</strong><br>
            <code>{{ user_info.instance_name }}</code>
        </div>
        <div>
            <strong>Unikalny ID:</strong><br>
            <code style="font-size: 0.8em;">{{ user_info.user_id }}</code>
        </div>
        <div>
            <strong>Utworzono:</strong><br>
            {{ user_info.created[:10] }}
        </div>
        <div>
            <strong>Wersja aplikacji:</strong><br>
            {{ user_info.app_version }}
        </div>
    </div>
</div>

<!-- Statystyki -->
<div style="background: #e8f5e8; padding: 20px; margin: 20px 0; border-radius: 8px;">
    <h3 style="margin-top: 0;">Statystyki</h3>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <div style="text-align: center;">
            <div style="font-size: 2em; font-weight: bold; color: #28a745;">
                {{ user_info.stats.prices_scraped or 0 }}
            </div>
            <div style="color: #666;">Pobranych cen</div>
        </div>
        <div style="text-align: center;">
            <div style="font-size: 2em; font-weight: bold; color: #17a2b8;">
                {{ user_info.stats.products_added or 0 }}
            </div>
            <div style="color: #666;">Dodanych produktów</div>
        </div>
        <div style="text-align: center;">
            <div style="font-size: 1.2em; color: #666;">
                {% if user_info.stats.last_scraping %}
                    {{ user_info.stats.last_scraping[:10] }}
                {% else %}
                    Nigdy
                {% endif %}
            </div>
            <div style="color: #666;">Ostatnie pobieranie</div>
        </div>
    </div>
</div>

<!-- Ustawienia -->
<form method="POST">
    <div style="background: white; padding: 20px; margin: 20px 0; border-radius: 8px; border: 1px solid #dee2e6;">
        <h3 style="margin-top: 0;">Ustawienia Danych</h3>
        
        <div style="margin: 20px 0;">
            <label style="display: flex; align-items: center;">
                <input type="checkbox" name="share_anonymous_data" 
                       {% if user_info.settings.share_anonymous_data %}checked{% endif %}
                       style="margin-right: 10px;">
                <strong>Udostępniaj anonimowe dane</strong>
            </label>
            <div style="font-size: 0.9em; color: #666; margin-top: 5px; margin-left: 25px;">
                Pomaga w ulepszaniu systemu poprzez wysyłanie anonimowych statystyk użytkowania.
                Twój unikalny ID zostaje zachowany w celach technicznych.
            </div>
        </div>
        
        <div style="margin: 20px 0;">
            <label style="display: flex; align-items: center;">
                <input type="checkbox" name="auto_upload_prices" 
                       {% if user_info.settings.auto_upload_prices %}checked{% endif %}
                       style="margin-right: 10px;">
                <strong>Automatyczne wysyłanie cen</strong>
            </label>
            <div style="font-size: 0.9em; color: #666; margin-top: 5px; margin-left: 25px;">
                Automatycznie wysyła pobrane ceny na serwer centralny (funkcja przyszłości).
                Pomaga w budowaniu wspólnej bazy danych cen.
            </div>
        </div>
        
        <div style="margin: 20px 0;">
            <label style="display: block; margin-bottom: 5px;">
                <strong>Priorytet źródła danych:</strong>
            </label>
            <select name="data_source_priority" style="width: 200px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                {% set current_priority = user_info.settings.data_source_priority or 'local' %}
                <option value="local" {% if current_priority == 'local' %}selected{% endif %}>Lokalne dane</option>
                <option value="server" {% if current_priority == 'server' %}selected{% endif %}>Serwer główny</option>
                <option value="hybrid" {% if current_priority == 'hybrid' %}selected{% endif %}>Hybrydowy</option>
            </select>
            <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                Określa skąd system pobiera dane: tylko lokalnie, z serwera, czy łączy oba źródła.
            </div>
        </div>
    </div>
    
    <div style="margin: 25px 0;">
        <button type="submit" class="btn" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; margin-right: 10px;">
            Zapisz ustawienia
        </button>
        <a href="{{ url_for('prices.prices') }}" 
           class="btn" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 4px; text-decoration: none;">
           Anuluj
        </a>
    </div>
</form>

<!-- Informacje techniczne -->
<div style="background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 8px; border-left: 4px solid #17a2b8;">
    <h3 style="margin-top: 0;">Informacje techniczne</h3>
    
    <div style="font-size: 0.9em; color: #666; line-height: 1.6;">
        <p><strong>Unikalny identyfikator użytkownika:</strong></p>
        <p>Twój system ma przypisane unikalne ID: <code>{{ user_info.user_id }}</code></p>
        <p>Ten identyfikator:</p>
        <ul>
            <li>Jest generowany losowo przy pierwszym uruchomieniu</li>
            <li>Pozwala na rozróżnienie danych od różnych użytkowników</li>
            <li>Nie zawiera żadnych danych osobowych</li>
            <li>Jest używany do synchronizacji danych z serwerem centralnym</li>
            <li>Pozostaje stały przez cały czas użytkowania aplikacji</li>
        </ul>
        
        <p><strong>Bezpieczeństwo i prywatność:</strong></p>
        <ul>
            <li>Wszystkie dane są przechowywane lokalnie na Twoim komputerze</li>
            <li>Wysyłanie danych na serwer wymaga Twojej zgody</li>
            <li>Przesyłane są tylko ceny produktów, bez danych osobowych</li>
            <li>Możesz w każdej chwili wyłączyć udostępnianie danych</li>
        </ul>
    </div>
</div>

<!-- Eksport/Import danych -->
<div style="background: white; padding: 20px; margin: 20px 0; border-radius: 8px; border: 1px solid #dee2e6;">
    <h3 style="margin-top: 0;">Zarządzanie danymi</h3>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <div>
            <button onclick="exportUserData()" class="btn" style="background: #17a2b8; color: white; width: 100%;">
                Eksportuj dane
            </button>
            <div style="font-size: 0.8em; color: #666; margin-top: 5px; text-align: center;">
                Pobierz kopię swoich danych
            </div>
        </div>
        
        <div>
            <button onclick="showStats()" class="btn" style="background: #ffc107; color: #000; width: 100%;">
                Szczegółowe statystyki
            </button>
            <div style="font-size: 0.8em; color: #666; margin-top: 5px; text-align: center;">
                Zobacz pełne statystyki
            </div>
        </div>
        
        <div>
            <button onclick="clearOldData()" class="btn" style="background: #dc3545; color: white; width: 100%;">
                Wyczyść stare dane
            </button>
            <div style="font-size: 0.8em; color: #666; margin-top: 5px; text-align: center;">
                Usuń dane starsze niż 30 dni
            </div>
        </div>
    </div>
</div>

<script>
async function exportUserData() {
    try {
        const response = await fetch('/api/user_info');
        const data = await response.json();
        
        if (data.success) {
            const exportData = {
                exported_at: new Date().toISOString(),
                user_info: data,
                export_version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `price_tracker_data_${data.user_id.slice(-8)}_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Dane zostały wyeksportowane');
        } else {
            alert('Błąd podczas eksportu: ' + data.error);
        }
    } catch (error) {
        alert('Błąd: ' + error.message);
    }
}

function showStats() {
    const userInfo = {{ user_info|tojson }};
    
    let statsHtml = `
        <div style="font-family: monospace; font-size: 0.9em; line-height: 1.4;">
            <h4>Szczegółowe statystyki użytkownika</h4>
            
            <p><strong>Instancja:</strong> ${userInfo.instance_name}</p>
            <p><strong>ID:</strong> ${userInfo.user_id}</p>
            <p><strong>Utworzono:</strong> ${userInfo.created}</p>
            <p><strong>Ostatnia aktualizacja:</strong> ${userInfo.updated || 'Brak'}</p>
            
            <h5>Statystyki:</h5>
            <ul>
                <li>Pobranych cen: ${userInfo.stats.prices_scraped || 0}</li>
                <li>Dodanych produktów: ${userInfo.stats.products_added || 0}</li>
                <li>Ostatnie pobieranie: ${userInfo.stats.last_scraping || 'Nigdy'}</li>
            </ul>
            
            <h5>Ustawienia:</h5>
            <ul>
                <li>Cen na stronę: ${userInfo.settings.prices_per_page || 50}</li>
                <li>Udostępnianie danych: ${userInfo.settings.share_anonymous_data ? 'Tak' : 'Nie'}</li>
                <li>Auto-upload: ${userInfo.settings.auto_upload_prices ? 'Tak' : 'Nie'}</li>
                <li>Priorytet danych: ${userInfo.settings.data_source_priority || 'local'}</li>
            </ul>
        </div>
    `;
    
    // Utwórz popup z statystykami
    const popup = window.open('', '_blank', 'width=600,height=500,scrollbars=yes');
    popup.document.write(`
        <html>
            <head><title>Statystyki Price Tracker</title></head>
            <body style="padding: 20px; font-family: Arial, sans-serif;">
                ${statsHtml}
                <button onclick="window.close()" style="margin-top: 20px; padding: 10px 20px;">Zamknij</button>
            </body>
        </html>
    `);
}

function clearOldData() {
    if (confirm('Czy na pewno chcesz usunąć wszystkie dane starsze niż 30 dni?\n\nTa operacja jest nieodwracalna!')) {
        alert('Funkcja czyszczenia danych będzie dostępna w przyszłej wersji.');
    }
}
</script>

<style>
.btn {
    text-decoration: none;
    border: none;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.2s;
    display: inline-block;
    text-align: center;
    font-size: 0.9em;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
</style>

{% endblock %}dee2e6;">
        <h3 style="margin-top: 0;">Ustawienia Wyświetlania</h3>
        
        <div style="margin: 20px 0;">
            <label style="display: block; margin-bottom: 5px;">
                <strong>Liczba cen na stronę:</strong>
            </label>
            <select name="prices_per_page" style="width: 200px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                {% set current_per_page = user_info.settings.prices_per_page or 50 %}
                <option value="10" {% if current_per_page == 10 %}selected{% endif %}>10 cen na stronę</option>
                <option value="25" {% if current_per_page == 25 %}selected{% endif %}>25 cen na stronę</option>
                <option value="50" {% if current_per_page == 50 %}selected{% endif %}>50 cen na stronę (domyślne)</option>
                <option value="100" {% if current_per_page == 100 %}selected{% endif %}>100 cen na stronę</option>
                <option value="200" {% if current_per_page == 200 %}selected{% endif %}>200 cen na stronę (maksimum)</option>
            </select>
            <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                Ile cen wyświetlać na jednej stronie. Więcej = szybsze przewijanie, ale wolniejsze ładowanie.
            </div>
        </div>
    </div>
    
    <div style="background: white; padding: 20px; margin: 20px 0; border-radius: 8px; border: 1px solid #